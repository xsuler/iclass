<style lang="less">
.image-upload-dialog {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;

  .dialog-content {
    background: white;
    border-radius: 16rpx;
    padding: 24rpx;
    width: 80%;
    box-shadow: 0 8rpx 32rpx rgba(0,0,0,0.1);
    
    .dialog-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20rpx;
    }
    
    .upload-box {
      border: 2rpx dashed #ccc;
      border-radius: 8rpx;
      padding: 40rpx;
      text-align: center;
    }
    
    .button-group {
      margin-top: 24rpx;
      display: flex;
      gap: 16rpx;
      
      button {
        flex: 1;
      }
    }
  }
}
</style>

<template>
  <view class="image-upload-dialog" wx:if="{{isOpen}}">
    <view class="dialog-content">
      <view class="dialog-header">
        <text class="title">ä¸Šä¼ å›¾ç‰‡</text>
        <text class="close" @tap="handleClose">Ã—</text>
      </view>
      
      <view class="upload-box" 
        @tap="handleChooseImage"
        style="{{isUploading ? 'opacity:0.7;pointer-events:none' : ''}}"
      >
        <view class="upload-placeholder">
          <text class="icon">{{isUploading ? 'â³' : 'ğŸ“¸'}}</text>
          <text class="text">{{isUploading ? 'æ­£åœ¨ä¸Šä¼ ä¸­...' : 'ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡'}}</text>
          <text class="hint">{{isUploading ? 'è¯·ç¨å€™' : 'æ”¯æŒæ‹ç…§æˆ–ä»ç›¸å†Œé€‰æ‹©'}}</text>
        </view>
      </view>

      <view class="button-group">
        <button @tap="handleClose">å–æ¶ˆ</button>
      </view>
    </view>
  </view>
  
  <!-- Add Course Confirmation Dialog -->
  <course-confirm-dialog 
    :isOpen.sync="showConfirmDialog"
    :courses.sync="detectedCourses"
    @close="handleConfirmClose"
    @confirm="handleConfirmCourses"
  />
</template>

<script>
import wepy from '@wepy/core'

wepy.component({
  props: {
    isOpen: Boolean,
    onUpload: {
      type: Function,
      default: () => {}  // Provide default empty function
    }
  },

  data: {
    isUploading: false,
    error: '',
    showConfirmDialog: false,
    detectedCourses: []
  },

  methods: {
    handleClose() {
      this.$emit('close')
    },

    async handleChooseImage() {
      try {
        const res = await wx.chooseImage({
          count: 1,
          sizeType: ['compressed'],
          sourceType: ['album', 'camera']
        })

        this.isUploading = true
        this.error = ''

        // ä½¿ç”¨å®˜æ–¹æ¨èçš„ä¸Šä¼ æ–¹å¼
        const uploadTask = wx.uploadFile({
          url: 'https://iclass.onrender.com/upload',
          filePath: res.tempFilePaths[0],
          name: 'file',
          formData: {
            user: 'admin'
          },
          success: (res) => {
            if (res.statusCode === 200) {
              try {
                const data = JSON.parse(res.data)
                if (data.courses && data.courses.length > 0) {
                  // Instead of directly emitting, show confirmation dialog
                  this.detectedCourses = data.courses
                  console.log('Detected courses:', this.detectedCourses)
                  this.showConfirmDialog = true
                } else {
                  wx.showToast({
                    title: 'æœªæ£€æµ‹åˆ°è¯¾ç¨‹',
                    icon: 'none',
                    duration: 2000
                  })
                }
              } catch (e) {
                this.error = 'æ•°æ®è§£æå¤±è´¥'
                console.error(e)
              }
            } else {
              this.error = `ä¸Šä¼ å¤±è´¥ï¼ˆ${res.statusCode}ï¼‰`
            }
          },
          fail: (err) => {
            this.error = 'ç½‘ç»œè¯·æ±‚å¤±è´¥'
            console.error(err)
          },
          complete: () => {
            this.isUploading = false
          }
        })

        uploadTask.onProgressUpdate((res) => {
          console.log('ä¸Šä¼ è¿›åº¦:', res.progress)
        })

      } catch (err) {
        this.error = 'é€‰æ‹©å›¾ç‰‡å¤±è´¥'
        this.isUploading = false
        console.error(err)
      }
    },
    
    handleConfirmClose() {
      this.showConfirmDialog = false
      this.detectedCourses = []
    },
    
    handleConfirmCourses(selectedCourses) {
      // Emit the selected courses to parent
      this.$emit('upload', selectedCourses)
      
      // Close both dialogs
      this.showConfirmDialog = false
      this.handleClose()
    }
  }
})
</script>

<config>
{
  usingComponents: {
    "course-confirm-dialog": "./CourseConfirmDialog"
  }
}
</config> 